@model RadioCab.Models.ServiceVM

@{
    ViewData["Title"] = "Services Management";
    Layout = "~/Views/Shared/admin.cshtml";
}

<link href="~/css/Service.css" rel="stylesheet" />
<div class="services-page">
    <!-- Success Message -->
    @if (TempData["ServiceSuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
            @TempData["ServiceSuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Page Header -->
    <div class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-2">Services Management</h1>
                <p class="text-muted mb-0">Manage all services available for companies and drivers</p>
            </div>
            <div class="col-md-4 text-md-end">
                <button class="btn btn-primary" id="addServiceBtn">
                    <i class="fas fa-plus-circle me-2"></i>Add New Service
                </button>
            </div>
        </div>
    </div>

    <!-- Services Table -->
    <div class="card">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0">All Services</h5>
                </div>
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search services..." id="searchInput">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th width="60">ID</th>
                            <th>Service Name</th>
                            <th>Description</th>
                            <th class="text-center">For Drivers</th>
                            <th class="text-center">For Companies</th>
                            <th width="100">Status</th>
                            <th width="140" class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var service in Model.service_list)
                        {
                            <tr>
                                <td class="fw-bold">S @service.ServiceId</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="service-icon me-3">
                                            <i class="fas fa-concierge-bell"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">@service.ServiceName</h6>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="service-description">
                                        @service.ServiceDescription
                                    </div>
                                </td>
                                <td class="text-center">
                                    <div class="availability-badge @(service.IsForDriver ? "availability-yes" : "availability-no")">
                                        <i class="fas @(service.IsForDriver ? "fa-check" : "fa-times")"></i>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <div class="availability-badge @(service.IsForCompany ? "availability-yes" : "availability-no")">
                                        <i class="fas @(service.IsForCompany ? "fa-check" : "fa-times")"></i>
                                    </div>
                                </td>
                                <td>
                                    @if (service.IsActive)
                                    {
                                        <span class="badge bg-success">Active</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning">Inactive</span>
                                    }
                                </td>
                                <td>
                                    <div class="d-flex justify-content-center gap-2">
                                        <button class="btn btn-sm btn-outline-primary view-service"
                                                data-service-id="@service.ServiceId"
                                                data-service-name="@service.ServiceName"
                                                data-service-description="@service.ServiceDescription"
                                                data-for-driver="@service.IsForDriver"
                                                data-for-company="@service.IsForCompany"
                                                data-service-status="@(service.IsActive ? "Active" : "Inactive")">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning edit-service"
                                                data-id="@service.ServiceId"
                                                data-name="@service.ServiceName"
                                                data-description="@service.ServiceDescription"
                                                data-for-driver="@service.IsForDriver"
                                                data-for-company="@service.IsForCompany"
                                                data-status="@(service.IsActive ? "true" : "false")">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-service"
                                                data-id="@service.ServiceId">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>  
        </div>
    </div>
</div>

<!-- Add Service Modal -->
<div class="modal fade" id="addServiceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2"></i>Add New Service
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addServiceForm" asp-action="Service" asp-controller="Admin" method="post">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="All" class="text-danger mb-3"></div>

                <div class="modal-body">
                    <div class="mb-4">
                        <label asp-for="Service_Form.ServiceName" class="form-label fw-medium">
                            <i class="fas fa-heading me-2 text-primary"></i>Service Name *
                        </label>
                        <input asp-for="Service_Form.ServiceName" class="form-control"
                               placeholder="Enter service name">
                        <span asp-validation-for="Service_Form.ServiceName" class="text-danger"></span>
                    </div>

                    <div class="mb-4">
                        <label asp-for="Service_Form.ServiceDescription" class="form-label fw-medium">
                            <i class="fas fa-align-left me-2 text-primary"></i>Description
                        </label>
                        <textarea asp-for="Service_Form.ServiceDescription" class="form-control"
                                  rows="4" placeholder="Describe the service..."></textarea>
                        <span asp-validation-for="Service_Form.ServiceDescription" class="text-danger"></span>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input asp-for="Service_Form.IsForDriver" class="form-check-input" type="checkbox">
                                <label asp-for="Service_Form.IsForDriver" class="form-check-label">
                                    <i class="fas fa-user-tie me-2"></i>Available for Drivers
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input asp-for="Service_Form.IsForCompany" class="form-check-input" type="checkbox">
                                <label asp-for="Service_Form.IsForCompany" class="form-check-label">
                                    <i class="fas fa-building me-2"></i>Available for Companies
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label asp-for="Service_Form.IsActive" class="form-label fw-medium">
                            <i class="fas fa-toggle-on me-2 text-primary"></i>Service Status
                        </label>
                        <select asp-for="Service_Form.IsActive" class="form-select">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Save Service
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Service Modal -->
<div class="modal fade" id="editServiceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Service
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editServiceForm" asp-action="EditService" asp-controller="Admin" method="post">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="All" class="text-danger mb-3"></div>

                <input type="hidden" asp-for="Service_Form.ServiceId" id="editServiceId">

                <div class="modal-body">
                    <div class="mb-3">
                        <label asp-for="Service_Form.ServiceName" class="form-label">Service Name *</label>
                        <input asp-for="Service_Form.ServiceName" class="form-control" id="editServiceName">
                        <span asp-validation-for="Service_Form.ServiceName" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Service_Form.ServiceDescription" class="form-label">Description</label>
                        <textarea asp-for="Service_Form.ServiceDescription" class="form-control"
                                  id="editServiceDescription" rows="4"></textarea>
                        <span asp-validation-for="Service_Form.ServiceDescription" class="text-danger"></span>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input asp-for="Service_Form.IsForDriver" class="form-check-input"
                                       type="checkbox" id="editIsForDriver">
                                <label asp-for="Service_Form.IsForDriver" class="form-check-label">
                                    Available for Drivers
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input asp-for="Service_Form.IsForCompany" class="form-check-input"
                                       type="checkbox" id="editIsForCompany">
                                <label asp-for="Service_Form.IsForCompany" class="form-check-label">
                                    Available for Companies
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Service_Form.IsActive" class="form-label">Status</label>
                        <select asp-for="Service_Form.IsActive" class="form-select" id="editServiceStatus">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save me-2"></i>Update Service
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Service Modal -->
<div class="modal fade" id="viewServiceModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Service Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="service-detail-header mb-4">
                    <div class="d-flex align-items-center">
                        <div class="service-detail-icon">
                            <i class="fas fa-concierge-bell"></i>
                        </div>
                        <div class="ms-3">
                            <h4 id="viewServiceName" class="mb-1"></h4>
                            <div class="d-flex align-items-center">
                                <span id="viewServiceStatus" class="badge me-2"></span>
                                <small class="text-muted">ID: <span id="viewServiceId"></span></small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="service-detail-content">
                    <h6 class="mb-3">Description</h6>
                    <div class="service-description-box p-3 mb-4">
                        <p id="viewServiceDescription" class="mb-0"></p>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="info-box">
                                <label class="form-label text-muted small mb-1">Available for Drivers</label>
                                <p id="viewForDriver" class="mb-0 fw-medium"></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-box">
                                <label class="form-label text-muted small mb-1">Available for Companies</label>
                                <p id="viewForCompany" class="mb-0 fw-medium"></p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label text-muted small mb-1">Created Date</label>
                            <p id="viewCreatedAt" class="mb-0 fw-medium"></p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted small mb-1">Status</label>
                            <p id="viewStatusDetail" class="mb-0 fw-medium"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<form id="antiForgeryForm">
    @Html.AntiForgeryToken()
</form>

<script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
<script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
            document.addEventListener('DOMContentLoaded', function() {
        // Set active navigation
        document.querySelector('[data-page="services-manage"]').classList.add('active');
    });

    // services-management.js - Complete JavaScript for Service Management
    document.addEventListener('DOMContentLoaded', function() {

        // ==================== MODAL INSTANCES ====================
        const addServiceModal = new bootstrap.Modal(document.getElementById('addServiceModal'));
        const editServiceModal = new bootstrap.Modal(document.getElementById('editServiceModal'));
        const viewServiceModal = new bootstrap.Modal(document.getElementById('viewServiceModal'));

        // ==================== ADD SERVICE MODAL ====================
        document.getElementById('addServiceBtn').addEventListener('click', function() {
            resetForm('addServiceForm');
            addServiceModal.show();
        });

        // ==================== EDIT SERVICE MODAL ====================
        document.querySelectorAll('.edit-service').forEach(btn => {
            btn.addEventListener('click', function() {
                resetForm('editServiceForm');

                // Set form values
                document.getElementById('editServiceId').value = this.dataset.id;
                document.getElementById('editServiceName').value = this.dataset.name;
                document.getElementById('editServiceDescription').value = this.dataset.description || '';
                document.getElementById('editIsForDriver').checked = this.dataset.forDriver === 'True';
                document.getElementById('editIsForCompany').checked = this.dataset.forCompany === 'True';
                document.getElementById('editServiceStatus').value = this.dataset.status;

                editServiceModal.show();
            });
        });

        // ==================== VIEW SERVICE MODAL ====================
        document.querySelectorAll('.view-service').forEach(btn => {
            btn.addEventListener('click', function() {
                document.getElementById('viewServiceId').textContent = 'S ' + this.dataset.serviceId;
                document.getElementById('viewServiceName').textContent = this.dataset.serviceName;
                document.getElementById('viewServiceDescription').textContent =
                    this.dataset.serviceDescription || 'No description provided';

                const statusBadge = document.getElementById('viewServiceStatus');
                statusBadge.textContent = this.dataset.serviceStatus;
                statusBadge.className = 'badge me-2 ' +
                    (this.dataset.serviceStatus === 'Active' ? 'bg-success' : 'bg-warning');

                document.getElementById('viewForDriver').textContent =
                    this.dataset.forDriver === 'True' ? 'Yes' : 'No';
                document.getElementById('viewForCompany').textContent =
                    this.dataset.forCompany === 'True' ? 'Yes' : 'No';

                viewServiceModal.show();
            });
        });

        // ==================== DELETE FUNCTIONALITY ====================
        document.querySelectorAll('.delete-service').forEach(btn => {
            btn.addEventListener('click', function() {
                const serviceId = this.dataset.id;
                const token = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]')?.value;

                Swal.fire({
                    title: 'Are you sure?',
                    text: 'This service will be permanently deleted!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#e74c3c',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, delete'
                }).then((result) => {
                    if (!result.isConfirmed) return;

                    Swal.fire({
                        title: 'Deleting...',
                        text: 'Please wait',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    fetch('/Admin/DeleteServiceAjax', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `id=${serviceId}&__RequestVerificationToken=${encodeURIComponent(token)}`
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Deleted!',
                                text: 'Service deleted successfully.'
                            });
                            this.closest('tr').remove();
                        } else {
                            Swal.fire('Error', data.message, 'error');
                        }
                    })
                    .catch(() => Swal.fire('Error', 'This Serive is already associated with driver or company.', 'error'));
                });
            });
        });

        // ==================== SEARCH FUNCTIONALITY ====================
        document.getElementById('searchInput')?.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // ==================== CLIENT-SIDE VALIDATION ====================
        // Validate: Service must be for Driver or Company
        function validateDriverCompanySelection() {
            // For Add Form
            const addForm = document.getElementById('addServiceForm');
            if (addForm) {
                addForm.addEventListener('submit', function(e) {
                    const isForDriver = document.getElementById('addServiceForm').querySelector('[name="Service_Form.IsForDriver"]').checked;
                    const isForCompany = document.getElementById('addServiceForm').querySelector('[name="Service_Form.IsForCompany"]').checked;

                    if (!isForDriver && !isForCompany) {
                        e.preventDefault();
                        showDriverCompanyError('addServiceForm', 'Service must be for Driver or Company (select at least one).');
                    }
                });

                // Real-time validation
                addForm.querySelectorAll('[name="Service_Form.IsForDriver"], [name="Service_Form.IsForCompany"]')
                    .forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            validateCheckboxes('addServiceForm');
                        });
                    });
            }

            // For Edit Form
            const editForm = document.getElementById('editServiceForm');
            if (editForm) {
                editForm.addEventListener('submit', function(e) {
                    const isForDriver = document.getElementById('editServiceForm').querySelector('[name="Service_Form.IsForDriver"]').checked;
                    const isForCompany = document.getElementById('editServiceForm').querySelector('[name="Service_Form.IsForCompany"]').checked;

                    if (!isForDriver && !isForCompany) {
                        e.preventDefault();
                        showDriverCompanyError('editServiceForm', 'Service must be for Driver or Company (select at least one).');
                    }
                });

                // Real-time validation
                editForm.querySelectorAll('[name="Service_Form.IsForDriver"], [name="Service_Form.IsForCompany"]')
                    .forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            validateCheckboxes('editServiceForm');
                        });
                    });
            }
        }

        function validateCheckboxes(formId) {
            const form = document.getElementById(formId);
            if (!form) return;

            const isForDriver = form.querySelector('[name="Service_Form.IsForDriver"]').checked;
            const isForCompany = form.querySelector('[name="Service_Form.IsForCompany"]').checked;

            if (!isForDriver && !isForCompany) {
                showDriverCompanyError(formId, 'Service must be for Driver or Company (select at least one).');
            } else {
                clearDriverCompanyError(formId);
            }
        }

        function showDriverCompanyError(formId, message) {
            const form = document.getElementById(formId);
            if (!form) return;

            // Remove existing error
            clearDriverCompanyError(formId);

            // Create error element
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger mt-2';
            errorDiv.id = formId + '-driver-company-error';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle me-2"></i>${message}`;

            // Find checkboxes container
            const checkboxesContainer = form.querySelector('.row.mb-4') || form.querySelector('.row.mb-3');
            if (checkboxesContainer) {
                checkboxesContainer.parentNode.insertBefore(errorDiv, checkboxesContainer.nextSibling);
            }

            // Highlight checkboxes
            form.querySelectorAll('[name="Service_Form.IsForDriver"], [name="Service_Form.IsForCompany"]')
                .forEach(checkbox => {
                    const parent = checkbox.closest('.form-check');
                    if (parent) {
                        parent.classList.add('text-danger');
                        parent.classList.add('fw-bold');
                    }
                });
        }

        function clearDriverCompanyError(formId) {
            const form = document.getElementById(formId);
            if (!form) return;

            // Remove error message
            const errorDiv = form.querySelector('#' + formId + '-driver-company-error');
            if (errorDiv) {
                errorDiv.remove();
            }

            // Remove highlighting
            form.querySelectorAll('[name="Service_Form.IsForDriver"], [name="Service_Form.IsForCompany"]')
                .forEach(checkbox => {
                    const parent = checkbox.closest('.form-check');
                    if (parent) {
                        parent.classList.remove('text-danger');
                        parent.classList.remove('fw-bold');
                    }
                });
        }

        // Initialize validation
        validateDriverCompanySelection();

        // ==================== MODAL CLOSE FIX ====================
        function setupModalCloseFix(modalElementId, modalInstance) {
            const modalElement = document.getElementById(modalElementId);
            if (!modalElement) return;

            // Fix Cancel button
            const cancelBtn = modalElement.querySelector('.btn-outline-secondary');
            if (cancelBtn) {
                // Remove existing listeners
                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

                // Add new listener
                newCancelBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    forceCloseModal(modalInstance);
                });
            }

            // Fix Close (X) button
            const closeBtn = modalElement.querySelector('.btn-close');
            if (closeBtn) {
                // Remove existing listeners
                const newCloseBtn = closeBtn.cloneNode(true);
                closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);

                // Add new listener
                newCloseBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    forceCloseModal(modalInstance);
                });
            }

            // Fix backdrop click
            modalElement.addEventListener('click', function(e) {
                if (e.target === this) {
                    forceCloseModal(modalInstance);
                }
            });
        }

        function forceCloseModal(modal) {
            modal.hide();
            setTimeout(() => {
                // Remove backdrop
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) {
                    backdrop.remove();
                }

                // Reset body
                document.body.classList.remove('modal-open');
                document.body.style.overflow = 'auto';
                document.body.style.paddingRight = '0';
            }, 100);
        }

        // Apply fixes to all modals
        setupModalCloseFix('addServiceModal', addServiceModal);
        setupModalCloseFix('editServiceModal', editServiceModal);
        setupModalCloseFix('viewServiceModal', viewServiceModal);

        // ==================== HELPER FUNCTIONS ====================
        function resetForm(formId) {
            const form = document.getElementById(formId);
            if (!form) return;

            form.reset();

            // Clear validation errors
            form.querySelectorAll('.text-danger').forEach(el => el.textContent = '');
            form.querySelectorAll('.field-validation-error').forEach(el => el.remove());

            // Clear validation summary
            const validationSummary = form.querySelector('.validation-summary-errors');
            if (validationSummary) validationSummary.remove();

            // Remove validation classes
            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            form.classList.remove('was-validated');

            // Clear custom Driver/Company error
            clearDriverCompanyError(formId);
        }

        // ==================== TABLE ROW HOVER EFFECTS ====================
        document.querySelectorAll('tbody tr').forEach(row => {
            row.addEventListener('mouseenter', function() {
                this.style.backgroundColor = 'rgba(252, 163, 17, 0.05)';
            });

            row.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '';
            });
        });

        // ==================== AUTO-SHOW MODALS ON PAGE LOAD ====================
        @if (ViewBag.OpenAddModal != null && (bool)ViewBag.OpenAddModal)
        {
                <text>
                setTimeout(() => {
                    addServiceModal.show();
                }, 300);
                </text>
        }

        @if (ViewBag.OpenEditModal != null && (bool)ViewBag.OpenEditModal)
        {
                <text>
                setTimeout(() => {
                    editServiceModal.show();
                }, 300);
                </text>
        }

        // ==================== ESC KEY TO CLOSE MODALS ====================
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (addServiceModal && document.getElementById('addServiceModal').classList.contains('show')) {
                    forceCloseModal(addServiceModal);
                }
                if (editServiceModal && document.getElementById('editServiceModal').classList.contains('show')) {
                    forceCloseModal(editServiceModal);
                }
                if (viewServiceModal && document.getElementById('viewServiceModal').classList.contains('show')) {
                    viewServiceModal.hide();
                }
            }
        });

        // ==================== FORM SUBMISSION HANDLING ====================
        // Prevent form submission from interfering with modal close
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function(e) {
                // If form has invalid required fields, prevent default browser validation
                const requiredFields = this.querySelectorAll('[required]');
                let hasEmptyRequired = false;

                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        hasEmptyRequired = true;
                        field.classList.add('is-invalid');
                    }
                });

                if (hasEmptyRequired) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
        });
    });

    // ==================== GLOBAL FUNCTIONS (can be called from anywhere) ====================

    function showSuccessMessage(message) {
        Swal.fire({
            icon: 'success',
            title: 'Success',
            text: message,
            timer: 2000,
            showConfirmButton: false
        });
    }

    function showErrorMessage(message) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: message,
            confirmButtonColor: '#e74c3c'
        });
    }

    function showLoading(message = 'Processing...') {
        Swal.fire({
            title: message,
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
    }

    function hideLoading() {
        Swal.close();
    }
</script>
