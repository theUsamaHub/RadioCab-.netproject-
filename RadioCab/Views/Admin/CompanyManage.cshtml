@model RadioCab.Models.CDVM

@{
    Layout = "~/Views/Shared/admin.cshtml";
}

<link href="~/css/companymanage.css" rel="stylesheet" />

<div class="company-management-page">
    <!-- Company Actions Bar -->
    <div class="company-actions-bar">
        <div class="action-buttons-container">
            <div class="status-filter">
                <select class="status-select" id="statusFilter">
                    <option value="">Filter by Status</option>
                    <option value="all">All Status</option>
                    <option value="Approved">Approved</option>
                    <option value="Pending">Pending</option>
                    <option value="Rejected">Rejected</option>
                </select>
            </div>

            <div class="status-filter">
                <select class="status-select" id="cityFilter">
                    <option value="all">All Cities</option>
                    @foreach (var city in Model.Company_list.Select(c => c.CityName).Distinct().OrderBy(c => c))
                    {
                        if (!string.IsNullOrEmpty(city))
                        {
                            <option value="@city">@city</option>
                        }
                    }
                </select>
            </div>

            <div class="membership-filter">
                <select class="membership-select" id="membershipFilter">
                    <option value="all">All Memberships</option>
                    @foreach (var c in Model.membership_list)
                    {
                        <option value="@c.MembershipName">@c.MembershipName</option>
                    }
                </select>
            </div>

            <div class="search-box" style="max-width: 300px;">
                <input type="text"
                       id="searchFilter"
                       placeholder="Search companies..."
                       class="search-input" />
            </div>

            <button id="resetFilters" class="btn btn-primary">
                <i class="fas fa-undo"></i> Reset
            </button>
        </div>
    </div>

    <!-- Companies Table -->
    <div class="companies-table-container">
        <div class="table-wrapper">
            <form id="antiForgeryForm">
                @Html.AntiForgeryToken()
            </form>

            @if (TempData["CompanyMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
                    @TempData["CompanyMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            @if (TempData["ErrorC"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
                    @TempData["ErrorC"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }

            <div id="filterResults" class="mb-3 text-muted">
                Showing <span id="visibleCount">@Model.Company_list.Count</span> of <span id="totalCount">@Model.Company_list.Count</span> companies
            </div>

            <table class="companies-table" id="companiesTable">
                <thead>
                    <tr>
                        <th>Company Name</th>
                        <th>Designation</th>
                        <th>Telephone</th>
                        <th>Fax Number</th>
                        <th>Email</th>
                        <th>City</th>
                        @* <th>Company Logo</th> *@
                        @* <th>FBR Certificate</th> *@
                        <th>Membership</th>
                        <th>RegisterStatus</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="companyTableBody">
                    @if (!Model.Company_list.Any())
                    {
                        <tr id="noCompaniesRow">
                            <td colspan="12" class="text-center py-5">
                                <div class="empty-state">
                                    <i class="bi bi-building display-4 text-muted mb-3"></i>
                                    <h4 class="text-muted">No Company Found</h4>
                                    <p class="text-muted mb-4">There are no Company records to display.</p>
                                </div>
                            </td>
                        </tr>
                    }

                    @foreach (var item in Model.Company_list)
                    {
                        <tr class="company-row"
                            data-status="@item.RegisterationStatus"
                            data-city="@item.CityName"
                            data-membership="@item.MembershipName"
                            data-name="@item.CompanyName.ToLower()"
                            data-email="@item.UserEmail.ToLower()"
                            data-phone="@item.UserPhone">
                            <td>
                                <div class="company-info">
                                    <div class="company-details">
                                        <strong>@item.CompanyName</strong>
                                        <small>Reg: #@item.CompanyId</small>
                                    </div>
                                </div>
                            </td>
                            <td>@item.Designation</td>
                            <td>@item.UserPhone</td>
                            <td>@item.FaxNumber</td>
                            <td>@item.UserEmail</td>
                            <td>@item.CityName</td>
                            @* <td>
                                <div class="logo-preview">
                                    @if (!string.IsNullOrEmpty(item.CompanyLogo))
                                    {
                                        <img src="@item.CompanyLogo"
                                             alt="Company Logo"
                                             style="width:50px; height:50px; object-fit:cover; border-radius:6px;" />
                                    }
                                    else
                                    {
                                        <div class="logo-placeholder">
                                            <i class="fas fa-building"></i>
                                        </div>
                                    }
                                </div>
                            </td> *@
                            @* <td>
                                <div class="certificate-link">
                                    @if (!string.IsNullOrEmpty(item.FBRCertificate))
                                    {
                                        <a href="@item.FBRCertificate"
                                           target="_blank">
                                            <i class="fas fa-file-pdf"></i> FBR Certificate @item.CompanyId
                                        </a>
                                    }
                                    else
                                    {
                                        <span class="text-muted">No Certificate</span>
                                    }
                                </div>
                            </td> *@
                            <td>
                                @if (item.MembershipName == "Premium")
                                {
                                    <span class="membership-id premium">PREMIUM</span>
                                }
                                else if (item.MembershipName == "Basic")
                                {
                                    <span class="membership-id basic">BASIC</span>
                                }
                                else
                                {
                                    <span class="membership-id free">@item.MembershipName</span>
                                }
                            </td>
                            <td>
                                @if (item.RegisterationStatus == "Approved")
                                {
                                    <span class="status-badge active">Approved</span>
                                }
                                else if (item.RegisterationStatus == "Rejected")
                                {
                                    <span class="status-badge inactive">Rejected</span>
                                }
                                else
                                {
                                    <span class="status-badge pending">Pending</span>
                                }
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a asp-action="CompanyDetail" asp-controller="Admin" asp-route-id="@item.CompanyId" class="btn-action view" title="View">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a asp-action="CompanyEdit" asp-controller="Admin" asp-route-id="@item.CompanyId" class="btn-action edit" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a href="javascript:void(0);" data-id="@item.CompanyId" class="btn-action delete js-delete-user" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set active navigation
        document.querySelector('[data-page="companies"]').classList.add('active');

        // Get filter elements
        const statusFilter = document.getElementById('statusFilter');
        const cityFilter = document.getElementById('cityFilter');
        const membershipFilter = document.getElementById('membershipFilter');
        const searchFilter = document.getElementById('searchFilter');
        const resetFiltersBtn = document.getElementById('resetFilters');
        const companyRows = document.querySelectorAll('.company-row');
        const noCompaniesRow = document.getElementById('noCompaniesRow');
        const visibleCountSpan = document.getElementById('visibleCount');
        const totalCountSpan = document.getElementById('totalCount');

        // Initialize total count
        totalCountSpan.textContent = companyRows.length;

        // Function to filter companies
        function filterCompanies() {
            const statusValue = statusFilter.value;
            const cityValue = cityFilter.value;
            const membershipValue = membershipFilter.value;
            const searchValue = searchFilter.value.toLowerCase().trim();

            let visibleCount = 0;

            companyRows.forEach(row => {
                let showRow = true;

                // Filter by status
                if (statusValue && statusValue !== 'all' && statusValue !== '') {
                    const rowStatus = row.getAttribute('data-status');
                    if (rowStatus !== statusValue) {
                        showRow = false;
                    }
                }

                // Filter by city
                if (showRow && cityValue && cityValue !== 'all') {
                    const rowCity = row.getAttribute('data-city') || '';
                    if (rowCity !== cityValue) {
                        showRow = false;
                    }
                }

                // Filter by membership
                if (showRow && membershipValue && membershipValue !== 'all') {
                    const rowMembership = row.getAttribute('data-membership') || '';
                    if (rowMembership !== membershipValue) {
                        showRow = false;
                    }
                }

                // Filter by search
                if (showRow && searchValue) {
                    const companyName = row.getAttribute('data-name') || '';
                    const companyEmail = row.getAttribute('data-email') || '';
                    const companyPhone = row.getAttribute('data-phone') || '';

                    if (!companyName.includes(searchValue) &&
                        !companyEmail.includes(searchValue) &&
                        !companyPhone.includes(searchValue)) {
                        showRow = false;
                    }
                }

                // Show/hide row
                if (showRow) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Update visible count
            visibleCountSpan.textContent = visibleCount;

            // Show/hide "no results" message
            if (noCompaniesRow) {
                if (visibleCount === 0) {
                    noCompaniesRow.style.display = '';
                } else {
                    noCompaniesRow.style.display = 'none';
                }
            } else if (visibleCount === 0) {
                // Create no results row if it doesn't exist
                const tbody = document.getElementById('companyTableBody');
                const noResultsRow = document.createElement('tr');
                noResultsRow.id = 'noResultsRow';
                noResultsRow.innerHTML = `
                    <td colspan="11" class="text-center py-5">
                        <div class="empty-state">
                            <i class="bi bi-search display-4 text-muted mb-3"></i>
                            <h4 class="text-muted">No Companies Found</h4>
                            <p class="text-muted mb-4">No companies match your filter criteria.</p>
                        </div>
                    </td>
                `;
                tbody.appendChild(noResultsRow);
            } else {
                // Remove no results row if it exists
                const noResultsRow = document.getElementById('noResultsRow');
                if (noResultsRow) {
                    noResultsRow.remove();
                }
            }
        }

        // Add event listeners to filters
        statusFilter.addEventListener('change', filterCompanies);
        cityFilter.addEventListener('change', filterCompanies);
        membershipFilter.addEventListener('change', filterCompanies);

        // Search filter with debounce
        let searchTimeout;
        searchFilter.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterCompanies, 300);
        });

        // Reset filters
        resetFiltersBtn.addEventListener('click', function() {
            statusFilter.value = '';
            cityFilter.value = 'all';
            membershipFilter.value = 'all';
            searchFilter.value = '';
            filterCompanies();
        });

        // Delete functionality
        document.querySelectorAll('.js-delete-user').forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.dataset.id;
                const token = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]').value;
                const row = this.closest('.company-row');

                Swal.fire({
                    title: 'Are you sure?',
                    text: 'This Company will be permanently deleted!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#e74c3c',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, delete'
                }).then((result) => {
                    if (!result.isConfirmed) return;

                    Swal.fire({
                        title: 'Deleting...',
                        text: 'Please wait',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    fetch('/Admin/DeleteCompanyAjax', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `id=${userId}&__RequestVerificationToken=${token}`
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Deleted!',
                                text: 'Company has been deleted.'
                            });

                            // Remove row from table
                            row.remove();

                            // Update counts
                            const remainingRows = document.querySelectorAll('.company-row');
                            visibleCountSpan.textContent = remainingRows.length;
                            totalCountSpan.textContent = remainingRows.length;

                            // Refilter to update display
                            filterCompanies();

                        } else {
                            Swal.fire('Error', data.message, 'error');
                        }
                    })
                    .catch(() => {
                        Swal.fire('Error', 'Something went wrong.', 'error');
                    });
                });
            });
        });

        // Initialize filters
        filterCompanies();
    });
</script>