@model IEnumerable<RadioCab.Models.AdvertisementListVM>
@{
    ViewData["Title"] = "My Advertisements";
    Layout = "~/Views/Shared/driverlayout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-ad me-2"></i>My Advertisements
                    </h5>
                    <div>
                        <span class="badge bg-info me-2">
                            <i class="fas fa-chart-bar me-1"></i>
                            Active: @(Model?.Count(a => a.IsActive) ?? 0) / @(ViewBag.MaxActiveAds == -1 ? "âˆž" : ViewBag.MaxActiveAds.ToString())
                        </span>
                        <a href="@Url.Action("CreateAdvertisement", "Driver")" class="btn btn-light btn-sm">
                            <i class="fas fa-plus me-1"></i>Create New
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            @TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            @TempData["Success"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    @if (Model == null || !Model.Any())
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-ad fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">No Advertisements Found</h4>
                            <p class="text-muted">You haven't created any advertisements yet.</p>
                            <a href="@Url.Action("CreateAdvertisement", "Driver")" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Create Your First Advertisement
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Advertisement</th>
                                        <th>Dates</th>
                                        <th>Status</th>
                                        <th>Payment</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var ad in Model)
                                    {
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-start">
                                                    @if (!string.IsNullOrEmpty(ad.AdImage))
                                                    {
                                                        <img src="@ad.AdImage" alt="@ad.Title" 
                                                             class="me-3 rounded" style="width: 60px; height: 60px; object-fit: cover;" />
                                                    }
                                                    else
                                                    {
                                                        <div class="me-3 bg-light rounded d-flex align-items-center justify-content-center" 
                                                             style="width: 60px; height: 60px;">
                                                            <i class="fas fa-image text-muted"></i>
                                                        </div>
                                                    }
                                                    <div>
                                                        <h6 class="mb-1 fw-bold">@ad.Title</h6>
                                                        <p class="mb-0 text-muted small">@ad.Description</p>
                                                        <div class="text-muted small">
                                                            <i class="fas fa-clock me-1"></i>
                                                            Created: @ad.CreatedAt.ToString("MMM dd, yyyy")
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="small">
                                                    <div><strong>Start:</strong> @ad.StartDate.ToString("MMM dd, yyyy")</div>
                                                    <div><strong>End:</strong> @ad.EndDate.ToString("MMM dd, yyyy")</div>
                                                    <div class="text-muted">
                                                        @{
                                                            var duration = (ad.EndDate - ad.StartDate).Days;
                                                        }
                                                        Duration: @duration days
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex flex-column gap-1">
                                                    <span class="badge bg-@(ad.ApprovalStatus == "Approved" ? "success" : ad.ApprovalStatus == "Pending" ? "warning" : "secondary")">
                                                        <i class="fas fa-@(ad.ApprovalStatus == "Approved" ? "check" : ad.ApprovalStatus == "Pending" ? "clock" : "times") me-1"></i>
                                                        @ad.ApprovalStatus
                                                    </span>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" 
                                                               id="status-@ad.AdvertisementId" 
                                                               @(ad.IsActive ? "checked" : "")
                                                               onchange="toggleStatus(@ad.AdvertisementId)" />
                                                        <label class="form-check-label small" for="status-@ad.AdvertisementId">
                                                            @(ad.IsActive ? "Active" : "Inactive")
                                                        </label>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div>
                                                    <span class="badge bg-@(ad.PaymentStatus == "Paid" ? "success" : ad.PaymentStatus == "Pending" ? "warning" : "danger")">
                                                        <i class="fas fa-credit-card me-1"></i>
                                                        @ad.PaymentStatus
                                                    </span>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    @if (ad.CanEdit)
                                                    {
                                                        <a href="@Url.Action("EditAdvertisement", "Driver", new { id = ad.AdvertisementId })" 
                                                           class="btn btn-sm btn-outline-primary" title="Edit">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                    }
                                                    else
                                                    {
                                                        <button class="btn btn-sm btn-outline-secondary" disabled title="Cannot edit after start date">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                    }
                                                    
                                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                                            onclick="deleteAdvertisement(@ad.AdvertisementId)" 
                                                            title="Delete Advertisement">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <!-- Statistics Summary -->
                        <div class="row mt-4">
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted mb-2">Total Ads</h6>
                                        <h3 class="mb-0 text-primary">@(Model?.Count() ?? 0)</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted mb-2">Active</h6>
                                        <h3 class="mb-0 text-success">@(Model?.Count(a => a.IsActive) ?? 0)</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted mb-2">Pending</h6>
                                        <h3 class="mb-0 text-warning">@(Model?.Count(a => a.ApprovalStatus == "Pending") ?? 0)</h3>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card bg-light">
                                    <div class="card-body text-center">
                                        <h6 class="text-muted mb-2">Paid</h6>
                                        <h3 class="mb-0 text-info">@(Model?.Count(a => a.PaymentStatus == "Paid") ?? 0)</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/driver-advertisement.js"></script>
    <script>
        // Global function for status toggle (called from onclick)
        function toggleStatus(advertisementId) {
            const checkbox = document.getElementById(`status-${advertisementId}`);
            const label = checkbox.nextElementSibling;
            
            // Show loading state
            checkbox.disabled = true;
            label.textContent = 'Updating...';
            
            // Make AJAX call to toggle status
            fetch(`/Driver/ToggleAdvertisementStatus/${advertisementId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    checkbox.checked = data.isActive;
                    label.textContent = data.isActive ? 'Active' : 'Inactive';
                    
                    // Show success message
                    const adManager = new DriverAdvertisementManager();
                    adManager.showToast(data.message, 'success');
                    
                    // Reload page after a short delay to show updated status
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    // Revert checkbox state
                    checkbox.checked = !checkbox.checked;
                    label.textContent = checkbox.checked ? 'Active' : 'Inactive';
                    
                    // Show error message
                    const adManager = new DriverAdvertisementManager();
                    adManager.showToast(data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error toggling advertisement status:', error);
                
                // Revert checkbox state
                checkbox.checked = !checkbox.checked;
                label.textContent = checkbox.checked ? 'Active' : 'Inactive';
                
                // Show error message
                const adManager = new DriverAdvertisementManager();
                adManager.showToast('An error occurred while updating status.', 'error');
            })
            .finally(() => {
                checkbox.disabled = false;
            });
        }

        // Global function for delete advertisement (called from onclick)
        function deleteAdvertisement(advertisementId) {
            if (!confirm('Are you sure you want to delete this advertisement? This action cannot be undone.')) {
                return;
            }
            
            // Show loading state
            const deleteButton = event.target;
            const originalContent = deleteButton.innerHTML;
            deleteButton.disabled = true;
            deleteButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
            
            // Make AJAX call to delete advertisement
            fetch(`/Driver/DeleteAdvertisement/${advertisementId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    const adManager = new DriverAdvertisementManager();
                    adManager.showToast(data.message, 'success');
                    
                    // Remove the deleted row from table
                    const row = deleteButton.closest('tr');
                    if (row) {
                        row.style.transition = 'opacity 0.3s';
                        row.style.opacity = '0';
                        
                        setTimeout(() => {
                            row.remove();
                        }, 300);
                    }
                } else {
                    // Show error message
                    const adManager = new DriverAdvertisementManager();
                    adManager.showToast(data.message, 'error');
                    
                    // Restore button state
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = originalContent;
                }
            })
            .catch(error => {
                console.error('Error deleting advertisement:', error);
                
                // Show error message and restore button
                const adManager = new DriverAdvertisementManager();
                adManager.showToast('An error occurred while deleting advertisement.', 'error');
                
                deleteButton.disabled = false;
                deleteButton.innerHTML = originalContent;
            });
        }
    </script>
}
