@model List<ContactRequest>
@{
    ViewData["Title"] = "Contact Requests";
    Layout = "~/Views/Shared/CompanyLayout.cshtml";
    
    var statusFilter = ViewBag.StatusFilter as string ?? "";
    var dateFrom = ViewBag.DateFrom as string ?? "";
    var dateTo = ViewBag.DateTo as string ?? "";
}

<div class="container-fluid">
    <h2 class="mb-4">Contact Requests</h2>

    <!-- Filter Section -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Filter Requests</h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select name="statusFilter" class="form-select">
                        @if (statusFilter == "All" || string.IsNullOrEmpty(statusFilter))
                        {
                            <option value="All" selected>All Status</option>
                        }
                        else
                        {
                            <option value="All">All Status</option>
                        }

                        <option value="New" selected="@(statusFilter == "New")">New</option>
                        <option value="Viewed" selected="@(statusFilter == "Viewed")">Viewed</option>
                        <option value="Replied" selected="@(statusFilter == "Replied")">Replied</option>
                        <option value="Closed" selected="@(statusFilter == "Closed")">Closed</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">From Date</label>
                    <input type="date" name="dateFrom" class="form-control" value="@dateFrom" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">To Date</label>
                    <input type="date" name="dateTo" class="form-control" value="@dateTo" />
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">Apply Filters</button>
                    <a href="@Url.Action("ContactRequests")" class="btn btn-secondary">Clear</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Requests Count -->
    <div class="alert alert-info d-flex justify-content-between align-items-center">
        <div>
            <i class="fas fa-envelope me-2"></i>
            <strong>@Model.Count</strong> contact request(s) found
            @if (!string.IsNullOrEmpty(statusFilter) && statusFilter != "All")
            {
                <span class="ms-2">(Filtered by: @statusFilter)</span>
            }
        </div>
        @if (Model.Any(r => r.Status == "New"))
        {
            <span class="badge bg-warning">
                <i class="fas fa-exclamation-circle me-1"></i>
                @Model.Count(r => r.Status == "New") new
            </span>
        }
    </div>

    @if (!Model.Any())
    {
        <div class="alert alert-info text-center py-4">
            <i class="fas fa-inbox fa-3x mb-3 text-muted"></i>
            <h4>No contact requests found</h4>
            <p class="mb-0">@(string.IsNullOrEmpty(statusFilter) || statusFilter == "All" ? 
                "You haven't received any contact requests yet." : 
                "No requests match the current filters.")</p>
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th width="5%">#</th>
                        <th>Name</th>
                        <th>Contact Info</th>
                        <th>Message</th>
                        <th width="12%">Status</th>
                        <th width="15%">Actions</th>
                        <th width="12%">Received</th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.Count; i++)
                    {
                        var item = Model[i];
                        <tr data-request-id="@item.ContactRequestId" class="@(item.Status == "New" ? "table-warning" : "")">
                            <td>@(i + 1)</td>
                            <td>
                                <strong>@item.Name</strong>
                                @if (!string.IsNullOrEmpty(item.Email))
                                {
                                    <br />
                                    <small class="text-muted">
                                        <i class="fas fa-user me-1"></i>
                                        @if (item.UserId.HasValue)
                                        {
                                            <text>Registered User</text>
                                        }
                                        else
                                        {
                                            <text>Guest User</text>
                                        }
                                    </small>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(item.Email))
                                {
                                    <div>
                                        <i class="fas fa-envelope me-1 text-primary"></i>
                                        <a href="mailto:@item.Email">@item.Email</a>
                                    </div>
                                }
                                @if (!string.IsNullOrEmpty(item.Phone))
                                {
                                    <div>
                                        <i class="fas fa-phone me-1 text-success"></i>
                                        <a href="tel:@item.Phone">@item.Phone</a>
                                    </div>
                                }
                            </td>
                            <td style="max-width: 300px;">
                                <div class="message-preview" style="max-height: 60px; overflow: hidden;">
                                    @item.Message
                                </div>
                                @if (item.Message.Length > 150)
                                {
                                    <button class="btn btn-sm btn-link view-more" data-message="@item.Message">
                                        View more...
                                    </button>
                                }
                            </td>
                            <td>
                                <span class="badge 
                                    @(item.Status == "New" ? "bg-warning" :
                                      item.Status == "Viewed" ? "bg-info" :
                                      item.Status == "Replied" ? "bg-success" : 
                                      "bg-secondary")">
                                    @item.Status
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <!-- View/Expand Message Button -->
                                    <button type="button" class="btn btn-outline-primary view-message" 
                                            data-id="@item.ContactRequestId"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#messageModal"
                                            title="View Message">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    
                                    <!-- Status Dropdown -->
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" 
                                                data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-cog"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a class="dropdown-item status-action" href="#" 
                                                   data-id="@item.ContactRequestId" data-status="Viewed">
                                                    <i class="fas fa-eye text-info me-2"></i>Mark as Viewed
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item status-action" href="#" 
                                                   data-id="@item.ContactRequestId" data-status="Replied">
                                                    <i class="fas fa-reply text-success me-2"></i>Mark as Replied
                                                </a>
                                            </li>
                                            <li>
                                                <a class="dropdown-item status-action" href="#" 
                                                   data-id="@item.ContactRequestId" data-status="Closed">
                                                    <i class="fas fa-times-circle text-danger me-2"></i>Mark as Closed
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                    
                                    <!-- Reply Button -->
                                    <a href="mailto:@item.Email?subject=RE: Your Contact Request" 
                                       class="btn btn-outline-success" title="Reply via Email">
                                        <i class="fas fa-reply"></i>
                                    </a>
                                </div>
                            </td>
                            <td>
                                @(item.CreatedAt?.ToString("dd MMM yyyy") ?? "N/A")
                                <br />
                                <small class="text-muted">@(item.CreatedAt?.ToString("hh:mm tt") ?? "")</small>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<!-- Message Modal -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Contact Request Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>From:</strong> <span id="modalSenderName"></span>
                </div>
                <div class="mb-3">
                    <strong>Contact:</strong> 
                    <span id="modalSenderContact"></span>
                </div>
                <hr />
                <div class="mb-3">
                    <strong>Message:</strong>
                </div>
                <div class="border rounded p-3 bg-light" id="modalMessageContent">
                    <!-- Message will be inserted here -->
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        Received on: <span id="modalReceivedDate"></span>
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="modalReplyBtn">
                    <i class="fas fa-reply me-1"></i>Reply via Email
                </button>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        $(document).ready(function() {
            // View more/less for message preview
            $('.view-more').click(function(e) {
                e.preventDefault();
                var fullMessage = $(this).data('message');
                var preview = $(this).prev('.message-preview');

                if ($(this).text() === 'View more...') {
                    preview.html(fullMessage).css('max-height', 'none');
                    $(this).text('View less');
                } else {
                    preview.html(fullMessage.substring(0, 150) + '...').css('max-height', '60px');
                    $(this).text('View more...');
                }
            });

            // View message in modal
            $('.view-message').click(function() {
                var id = $(this).data('id');
                var row = $(this).closest('tr');
                var name = row.find('td:eq(1) strong').text();
                var email = row.find('td:eq(2) a[href^="mailto:"]').attr('href')?.replace('mailto:', '') || '';
                var phone = row.find('td:eq(2) a[href^="tel:"]').attr('href')?.replace('tel:', '') || '';
                var message = row.find('.message-preview').text();
                var date = row.find('td:eq(6)').text();

                $('#modalSenderName').text(name);
                $('#modalSenderContact').html(
                    (email ? '<br><i class="fas fa-envelope me-1"></i><a href="mailto:' + email + '">' + email + '</a>' : '') +
                    (phone ? '<br><i class="fas fa-phone me-1"></i><a href="tel:' + phone + '">' + phone + '</a>' : '')
                );
                $('#modalMessageContent').text(message);
                $('#modalReceivedDate').text(date);
                $('#modalReplyBtn').attr('href', 'mailto:' + email + '?subject=RE: Your Contact Request');

                // Mark as viewed if status is New
                if (row.hasClass('table-warning')) {
                    markAsViewed(id, row);
                }
            });

            // Mark as viewed function
            function markAsViewed(id, row) {
                $.post('@Url.Action("MarkAsViewed")', { id: id }, function(response) {
                    if (response.success) {
                        row.removeClass('table-warning');
                        var statusBadge = row.find('.badge');
                        statusBadge.removeClass('bg-warning').addClass('bg-info').text('Viewed');
                        updateNotificationCount();
                    }
                });
            }

            // Update status via dropdown
                 $('.status-action').click(function(e) {
            e.preventDefault();
            var id = $(this).data('id');
            var status = $(this).data('status');
            var row = $(this).closest('tr');
            var currentStatus = row.find('.badge').text();

            // Don't ask for confirmation if changing to the same status
            if (currentStatus === status) return;

            // Confirm the change for certain statuses
            var confirmMessage = "Are you sure you want to mark this as '" + status + "'?";
            if (status === 'Closed') {
                confirmMessage = "Are you sure you want to close this request? This action cannot be undone.";
            }

            if (!confirm(confirmMessage)) return;

            $.post('@Url.Action("UpdateStatus")', { id: id, status: status }, function(response) {
                if (response.success) {
                    // Show success message
                    showToast('Status updated successfully', 'success');

                    // Update UI as before...
                    var badge = row.find('.badge');
                    badge.removeClass('bg-warning bg-info bg-success bg-secondary');

                    if (status === 'New') badge.addClass('bg-warning');
                    else if (status === 'Viewed') badge.addClass('bg-info');
                    else if (status === 'Replied') badge.addClass('bg-success');
                    else if (status === 'Closed') badge.addClass('bg-secondary');

                    badge.text(status);
                    row.removeClass('table-warning');
                    if (status === 'New') row.addClass('table-warning');

                    updateNotificationCount();
                }
            });
        });

        // Toast notification function
        function showToast(message, type) {
            // Create toast element
            var toast = $('<div class="toast align-items-center text-white bg-' +
                         (type === 'success' ? 'success' : 'danger') +
                         ' border-0" role="alert">' +
                         '<div class="d-flex">' +
                         '<div class="toast-body">' + message + '</div>' +
                         '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>' +
                         '</div></div>');

            // Add to container
            $('.toast-container').append(toast);

            // Show toast
            var bsToast = new bootstrap.Toast(toast[0]);
            bsToast.show();

            // Remove after hiding
            toast.on('hidden.bs.toast', function() {
                $(this).remove();
            });
        }

            // Update notification count (if you have one in your layout)
            function updateNotificationCount() {
                var newCount = $('tr.table-warning').length;
                // Update any notification badge in your layout
                $('.badge.bg-warning').text(newCount);
                if (newCount === 0) {
                    $('.badge.bg-warning').hide();
                } else {
                    $('.badge.bg-warning').show();
                }
            }

            // Auto-mark as viewed when modal is shown
            $('#messageModal').on('show.bs.modal', function(event) {
                var button = $(event.relatedTarget);
                var id = button.data('id');
                var row = button.closest('tr');

                if (row.hasClass('table-warning')) {
                    markAsViewed(id, row);
                }
            });
        });
    </script>
}